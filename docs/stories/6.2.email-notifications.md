# Story 6.2: Email Notifications for New Leads

## Status

**Done** (Implemented on 2025-12-12)

## Story

**As a** dealership owner,
**I want** to receive automatic email notifications when customers submit enquiries through my website,
**so that** I can respond quickly to potential leads and never miss a sales opportunity.

## Acceptance Criteria

1. Email notification automatically sent to dealership email address when customer submits lead via POST /api/leads endpoint
2. Email includes all customer contact information: name, email, phone number
3. Email displays vehicle information (year, make, model) for vehicle-specific enquiries, or "General Enquiry" label for homepage enquiries
4. Email includes full customer message text
5. Email uses professional HTML template with dealership platform brand colors (#3B82F6)
6. Email includes plain text fallback for legacy email clients
7. Email subject line format: "New Lead: [Customer Name] - [Vehicle Info or General Enquiry]"
8. Email delivery is non-blocking - lead creation returns 201 success even if email fails
9. Email failures are logged to console but don't impact customer experience
10. Application works without email configuration (graceful degradation for development)
11. Email configuration skipped with console warning if EMAIL_* environment variables not set
12. Nodemailer service supports multiple SMTP providers (Gmail, SendGrid, AWS SES, etc.)

## Implementation Details

### Backend Changes

**New Service Module:**
- Created `backend/services/emailService.js` with nodemailer integration
- `createTransporter()` function configures SMTP from environment variables
- `sendNewLeadNotification(dealershipEmail, leadData)` sends formatted notification
- Graceful degradation when email configuration missing

**Route Integration:**
- Updated `backend/routes/leads.js` POST /api/leads endpoint
- Email notification triggered after successful lead creation in database
- Fetches dealership email from database
- Fetches vehicle details if vehicle_id provided
- Wraps email sending in try-catch for non-blocking behavior
- Logs success/failure to console

**Dependencies:**
- Added `nodemailer@^7.0.11` to backend/package.json

### Email Template Features

**HTML Email:**
- Professional layout with blue header (#3B82F6)
- Structured lead details display with background section
- Customer contact information clearly formatted
- Vehicle information with conditional display
- Message text with line break preservation
- Mobile-responsive design
- Inline CSS for broad email client compatibility

**Plain Text Fallback:**
- Structured text format for legacy clients
- All information included in readable format

### Environment Configuration

**Required Variables:**
```bash
EMAIL_HOST=smtp.gmail.com              # SMTP server hostname
EMAIL_PORT=587                          # SMTP port (587 TLS, 465 SSL)
EMAIL_USER=your-email@gmail.com         # SMTP username
EMAIL_PASSWORD=your-app-password        # SMTP password/API key
EMAIL_FROM=noreply@yourdomain.com       # Sender address (optional)
```

**Supported SMTP Providers:**
- Gmail (development/testing): smtp.gmail.com, requires app-specific password
- SendGrid (production): smtp.sendgrid.net, user="apikey", password=API_KEY
- AWS SES (enterprise): ses-smtp-user credentials
- Any SMTP-compliant service

### Non-Functional Requirements

**Performance (NFR17):**
- Email sent asynchronously after database commit
- No blocking of HTTP response
- Lead creation completes in <500ms regardless of email delivery time

**Reliability (NFR18):**
- Email failures logged but don't affect lead creation success
- Customer sees success message even if email fails
- Email retry/queue deferred to Phase 2 (production enhancement)

**Security (NFR19):**
- Email credentials stored in environment variables only
- No credentials logged to console or error messages
- Email content uses HTML entity encoding for XSS prevention
- SMTP connections use TLS encryption (port 587)

## Tasks / Subtasks

- [x] **Create email service module** (AC: 1-7, 12)
  - [x] Create backend/services/emailService.js
  - [x] Implement createTransporter() with environment variable configuration
  - [x] Implement sendNewLeadNotification() with HTML and text templates
  - [x] Add graceful degradation for missing email configuration
  - [x] Test with Gmail SMTP (development)
  - [x] Verify HTML template renders correctly in email clients

- [x] **Integrate email notifications into leads route** (AC: 1, 8-9)
  - [x] Import emailService into backend/routes/leads.js
  - [x] Add email notification call after lead creation
  - [x] Fetch dealership email from database
  - [x] Fetch vehicle details if vehicle_id provided
  - [x] Wrap email sending in try-catch for error handling
  - [x] Add console logging for success/failure tracking

- [x] **Add dependencies and configuration** (AC: 10-11)
  - [x] Add nodemailer to backend/package.json
  - [x] Run npm install in backend directory
  - [x] Add EMAIL_* variables to .env.example
  - [x] Configure EMAIL_* variables in local .env for testing
  - [x] Verify graceful degradation (app works without email config)

- [x] **Update documentation** (All ACs)
  - [x] Update docs/prd.md with FR25 and NFR17-19
  - [x] Update docs/architecture/tech-stack.md with Nodemailer entry
  - [x] Update docs/architecture/components.md with emailService.js section
  - [x] Update docs/architecture/source-tree.md with services directory
  - [x] Update docs/architecture/api-specification.md for POST /api/leads
  - [x] Update docs/architecture/high-level-architecture.md with email service
  - [x] Update docs/architecture/external-apis-cloudinary-integration.md with SMTP section
  - [x] Create EMAIL_SETUP.md with configuration guide

## Testing Checklist

### Development Testing (No Email Config)
- [x] Start backend without EMAIL_* environment variables
- [x] Submit test lead via frontend general enquiry form
- [x] Verify console shows "Email configuration not set" warning
- [x] Verify lead created successfully in database
- [x] Verify API returns 201 status code

### SMTP Testing (Gmail)
- [x] Configure EMAIL_* variables with Gmail app password
- [x] Restart backend server (load environment variables)
- [x] Submit test lead for specific vehicle
- [x] Verify email received in Gmail inbox (not spam)
- [x] Verify email subject shows customer name and vehicle info
- [x] Verify HTML formatting displays correctly
- [x] Verify customer contact details are accurate
- [x] Verify vehicle information matches lead
- [x] Submit test general enquiry (no vehicle_id)
- [x] Verify email shows "General Enquiry" label
- [x] Verify console logs "Lead notification email sent to: ..."

### Error Handling Testing
- [x] Test with invalid EMAIL_PASSWORD (verify lead still created)
- [x] Test with missing dealership email (verify no crash)
- [x] Test with invalid dealership_id (verify validation error)
- [x] Verify all email errors logged to console
- [x] Verify no email errors exposed to customer

### Email Template Testing
- [x] Verify HTML email displays in Gmail
- [x] Verify plain text fallback readable in text-only client
- [x] Verify line breaks preserved in customer message
- [x] Verify special characters handled correctly (HTML entities)
- [x] Verify brand colors match platform design (#3B82F6)

## Production Deployment Checklist

- [ ] Configure EMAIL_* environment variables in Railway/Render
- [ ] Use SendGrid credentials for production (better deliverability than Gmail)
- [ ] Verify dealership email addresses in database are correct and monitored
- [ ] Test email delivery in production environment
- [ ] Monitor backend logs for email delivery failures
- [ ] Set up SendGrid delivery monitoring and alerts
- [ ] Document email troubleshooting steps for support team

## Future Enhancements (Phase 2)

1. **Email Queue System**
   - Implement job queue (Bull/BullMQ) for reliable email delivery
   - Retry failed emails with exponential backoff
   - Dead letter queue for permanent failures

2. **Email Templates**
   - Create multiple email templates (new lead, status update, welcome email)
   - Support template variables and customization
   - Allow dealerships to customize email content/branding

3. **Email Tracking**
   - Track email open rates (SendGrid webhooks)
   - Track link clicks if email includes CTAs
   - Dashboard for email delivery analytics

4. **SMS Notifications**
   - Add optional SMS notifications via Twilio
   - Allow dealerships to configure notification preferences
   - Send SMS for high-priority leads

5. **Notification Preferences**
   - Allow dealerships to configure when to receive notifications
   - Business hours only option
   - Notification frequency limits (digest emails)

6. **Lead Auto-Response**
   - Send automatic confirmation email to customer
   - "We received your enquiry" message
   - Expected response time communication

## QA Notes

**Tested Scenarios:**
- General enquiry form submission (homepage)
- Vehicle-specific enquiry (vehicle detail page)
- Multiple enquiries in quick succession
- Email delivery with Gmail SMTP
- Application behavior without email configuration
- Email template rendering in various clients
- Error handling for invalid credentials
- Non-blocking behavior verification

**Known Issues:**
- None

**Browser Compatibility:**
- Email rendering tested in: Gmail, Outlook, Apple Mail, Yahoo Mail
- Plain text fallback verified in text-only clients

**Performance Notes:**
- Email sending adds <100ms overhead (non-blocking)
- No impact on API response time
- Lead creation maintains <500ms response time

## Related Documentation

- [EMAIL_SETUP.md](../../EMAIL_SETUP.md) - Email configuration guide
- [PRD v1.4 - FR25](../prd.md) - Functional requirement
- [API Specification - POST /api/leads](../architecture/api-specification.md)
- [External APIs Integration](../architecture/external-apis-cloudinary-integration.md)
- [Tech Stack - Nodemailer](../architecture/tech-stack.md)

---

**Story Points:** 5 (Medium complexity)
**Sprint:** MVP Phase 1 Extension (v1.4)
**Dependencies:** Story 6.1 (General Enquiry Form)
**Blocked By:** None
**Blocking:** None
