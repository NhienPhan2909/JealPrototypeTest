# Story 1.2: Database Schema & Seed Data

## Status

**Done**

## Story

**As a** developer,
**I want** to create the PostgreSQL database schema and seed initial dealership data,
**so that** I have the multi-tenant data model ready for API development and testing.

## Acceptance Criteria

1. PostgreSQL database connection established using `pg` client with `DATABASE_URL` from environment variables
2. `Dealership` table created with columns: `id` (serial primary key), `name` (varchar), `logo_url` (varchar nullable), `address` (text), `phone` (varchar), `email` (varchar), `hours` (text), `about` (text), `created_at` (timestamp)
3. `Vehicle` table created with columns: `id` (serial primary key), `dealership_id` (integer FK to Dealership), `make` (varchar), `model` (varchar), `year` (integer), `price` (decimal), `mileage` (integer), `condition` (varchar: new/used), `status` (varchar: active/sold/pending/draft), `title` (varchar), `description` (text), `images` (jsonb array of URLs), `created_at` (timestamp)
4. `Lead` table created with columns: `id` (serial primary key), `dealership_id` (integer FK to Dealership), `vehicle_id` (integer FK to Vehicle, nullable), `name` (varchar), `email` (varchar), `phone` (varchar), `message` (text), `created_at` (timestamp)
5. Foreign key constraints enforce referential integrity (`dealership_id` in Vehicle and Lead must reference valid Dealership)
6. Indexes created on `dealership_id` columns in Vehicle and Lead tables for query performance
7. Database seeded with 2 sample dealerships: "Acme Auto Sales" and "Premier Motors" with complete profile information
8. Database connection can be tested with simple query (e.g., `SELECT * FROM Dealership`)

## Tasks / Subtasks

- [x] Create database connection module (AC: 1, 8)
  - [x] Create `backend/db/index.js` with PostgreSQL connection pool
  - [x] Configure connection using DATABASE_URL from environment variables
  - [x] Add SSL configuration for production (Railway/Render requires `rejectUnauthorized: false`)
  - [x] Add connection test query on startup to verify database connectivity
  - [x] Add JSDoc documentation per coding standards

- [x] Create database schema script (AC: 2, 3, 4, 5, 6)
  - [x] Create `backend/db/schema.sql` file
  - [x] Add DROP TABLE statements for clean setup (lead, vehicle, dealership)
  - [x] Create Dealership table with all specified columns and constraints
  - [x] Create Vehicle table with all columns, CHECK constraints for condition/status, and foreign key to Dealership
  - [x] Create Lead table with all columns and foreign keys to Dealership and Vehicle
  - [x] Add indexes: idx_vehicle_dealership_id, idx_lead_dealership_id, idx_vehicle_status, idx_lead_created_at, idx_vehicle_dealership_status
  - [x] Verify foreign key cascade rules (ON DELETE CASCADE for dealership, ON DELETE SET NULL for vehicle_id in leads)

- [x] Create seed data script (AC: 7)
  - [x] Create `backend/db/seed.sql` file
  - [x] Insert 2 dealerships: "Acme Auto Sales" and "Premier Motors" with complete profile data
  - [x] Insert 5 vehicles for Dealership 1 (Acme Auto Sales) with varied status values
  - [x] Insert 5 vehicles for Dealership 2 (Premier Motors) with varied status values
  - [x] Insert 3 sample leads for Dealership 1 (some with vehicle_id, some without)
  - [x] Insert 2 sample leads for Dealership 2

- [x] Run database scripts and verify setup (AC: 1, 8)
  - [x] Start PostgreSQL container: `docker-compose up -d`
  - [x] Update .env file with Docker DATABASE_URL: `postgresql://postgres:postgres@localhost:5432/jeal_prototype`
  - [x] Run schema.sql script: `docker exec -i jeal-prototype-db psql -U postgres -d jeal_prototype < backend\db\schema.sql`
  - [x] Run seed.sql script: `docker exec -i jeal-prototype-db psql -U postgres -d jeal_prototype < backend\db\seed.sql`
  - [x] Verify tables created: `docker exec -it jeal-prototype-db psql -U postgres -d jeal_prototype -c "SELECT * FROM dealership;"`
  - [x] Verify vehicle count: `docker exec -it jeal-prototype-db psql -U postgres -d jeal_prototype -c "SELECT COUNT(*) FROM vehicle;"`
  - [x] Verify lead count: `docker exec -it jeal-prototype-db psql -U postgres -d jeal_prototype -c "SELECT COUNT(*) FROM lead;"`
  - [x] Test database connection from backend by starting server and checking console logs

## Dev Notes

### Previous Story Insights

Story 1.1 established the foundational monorepo structure and Express server. The following components are already in place:
- Monorepo with `/backend` and `/frontend` directories
- Express server running on port 5000 with health check endpoint
- Environment variables configured in `.env.example` including `DATABASE_URL`
- `pg` (node-postgres) client already installed as dependency (version ^8.11.3)
- Manual testing approach for MVP (no automated tests)

The backend server is ready to connect to the database - this story adds the database layer.

[Source: Story 1.1 completion notes]

### Database Technology Stack

**Database:** PostgreSQL 14+ (Docker for local development, Railway/Render for production)
- ACID guarantees and foreign keys for multi-tenancy integrity
- JSONB support for storing vehicle image arrays
- Docker container for consistent local development environment
- Free tier cloud hosting sufficient for MVP data volumes

**Database Client:** pg (node-postgres) 8.11+
- Official PostgreSQL client for Node.js
- Parameterized queries prevent SQL injection
- Connection pooling for performance
- No ORM overhead (Prisma/Sequelize adds complexity)

[Source: architecture/tech-stack.md#technology-stack-table]

### File Locations

**Backend Database Files (to be created):**
- `backend/db/index.js` - PostgreSQL connection pool setup
- `backend/db/schema.sql` - Database schema (CREATE TABLE statements)
- `backend/db/seed.sql` - Seed data (INSERT statements for demo data)

**Note:** Additional query files will be created in later stories:
- `backend/db/dealers.js` - Dealership queries (Story 1.3)
- `backend/db/vehicles.js` - Vehicle queries (Story 1.4)
- `backend/db/leads.js` - Lead queries (Story 1.5)

[Source: architecture/source-tree.md#backend-structure]

### Database Connection Pool Implementation

**File:** `backend/db/index.js`

```javascript
const { Pool } = require('pg');

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production'
    ? { rejectUnauthorized: false }
    : false
});

// Test connection
pool.query('SELECT NOW()', (err, res) => {
  if (err) {
    console.error('Database connection error:', err);
  } else {
    console.log('Database connected successfully');
  }
});

module.exports = pool;
```

**Key Implementation Details:**
- Use `Pool` from pg client (not individual Client connections)
- Connection string from `DATABASE_URL` environment variable
- SSL disabled for local Docker (`ssl: false`), enabled for production with `rejectUnauthorized: false`
- Test connection on startup with simple `SELECT NOW()` query
- Export pool instance for use in route handlers

[Source: architecture/source-tree.md#backend-files]

### Data Models

**Three core entities with multi-tenant relationships:**

#### Dealership Table
- Primary tenant entity - each dealership is independent
- Stores profile information (name, logo, contact details, hours, about text)
- One-to-Many relationships with Vehicle and Lead tables

**Columns:**
- `id` SERIAL PRIMARY KEY
- `name` VARCHAR(255) NOT NULL
- `logo_url` TEXT (nullable)
- `address` TEXT NOT NULL
- `phone` VARCHAR(20) NOT NULL
- `email` VARCHAR(255) NOT NULL
- `hours` TEXT
- `about` TEXT
- `created_at` TIMESTAMP DEFAULT NOW()

[Source: architecture/data-models.md#dealership]

#### Vehicle Table
- Represents dealership inventory items
- Multi-tenancy via `dealership_id` foreign key (ON DELETE CASCADE)
- JSONB column for image URLs array
- CHECK constraints on `condition` (new/used) and `status` (active/sold/pending/draft)

**Columns:**
- `id` SERIAL PRIMARY KEY
- `dealership_id` INTEGER NOT NULL REFERENCES dealership(id) ON DELETE CASCADE
- `make` VARCHAR(100) NOT NULL
- `model` VARCHAR(100) NOT NULL
- `year` INTEGER NOT NULL
- `price` DECIMAL(10,2) NOT NULL
- `mileage` INTEGER NOT NULL
- `condition` VARCHAR(10) NOT NULL CHECK (condition IN ('new', 'used'))
- `status` VARCHAR(10) NOT NULL DEFAULT 'draft' CHECK (status IN ('active', 'sold', 'pending', 'draft'))
- `title` VARCHAR(255) NOT NULL
- `description` TEXT
- `images` JSONB DEFAULT '[]'::jsonb
- `created_at` TIMESTAMP DEFAULT NOW()

**Status Field Values:**
- `active` - Public-visible, available for sale
- `pending` - Public-visible with "Pending Sale" badge
- `sold` - Hidden from public, visible in admin
- `draft` - Admin-only, not published to public site

[Source: architecture/data-models.md#vehicle]

#### Lead Table
- Customer enquiries from public website
- Multi-tenancy via `dealership_id` foreign key (ON DELETE CASCADE)
- Optional `vehicle_id` reference (ON DELETE SET NULL - preserves lead history if vehicle deleted)

**Columns:**
- `id` SERIAL PRIMARY KEY
- `dealership_id` INTEGER NOT NULL REFERENCES dealership(id) ON DELETE CASCADE
- `vehicle_id` INTEGER REFERENCES vehicle(id) ON DELETE SET NULL (nullable)
- `name` VARCHAR(255) NOT NULL
- `email` VARCHAR(255) NOT NULL
- `phone` VARCHAR(20) NOT NULL
- `message` TEXT NOT NULL
- `created_at` TIMESTAMP DEFAULT NOW()

[Source: architecture/data-models.md#lead]

### Database Indexes for Performance

**Critical indexes for multi-tenant queries:**
- `idx_vehicle_dealership_id ON vehicle(dealership_id)` - Most critical for filtering vehicles by dealership
- `idx_lead_dealership_id ON lead(dealership_id)` - Required for lead inbox queries

**Additional performance indexes:**
- `idx_vehicle_status ON vehicle(status)` - Public site filters by active/pending status
- `idx_lead_created_at ON lead(created_at DESC)` - Admin inbox sorts leads newest-first
- `idx_vehicle_dealership_status ON vehicle(dealership_id, status)` - Composite index for common query pattern

[Source: architecture/database-schema.md#indexes-for-performance]

### Multi-Tenancy Data Isolation Rules

**CRITICAL IMPLEMENTATION RULE:** All future API queries MUST filter by `dealership_id` to prevent data leaks between dealerships.

**Example (from architecture docs):**
```javascript
// ‚úÖ CORRECT - filters by dealership
const vehicles = await db.query(
  'SELECT * FROM vehicle WHERE dealership_id = $1 AND status = $2',
  [dealershipId, 'active']
);

// ‚ùå WRONG - no dealership filter (data leak!)
const vehicles = await db.query('SELECT * FROM vehicle WHERE status = $1', ['active']);
```

**Database constraints enforce integrity:**
- Foreign key constraints prevent orphaned records
- `ON DELETE CASCADE` for dealership ensures cleanup of related vehicles/leads
- `ON DELETE SET NULL` for lead.vehicle_id preserves customer enquiry history
- `CHECK` constraints prevent invalid values for condition/status fields

[Source: architecture/data-models.md#multi-tenancy-data-isolation]

### Complete Schema SQL Script

The complete `schema.sql` script is provided in the architecture documentation with:
- DROP TABLE statements for clean setup
- CREATE TABLE statements for all three tables
- All foreign key constraints with proper cascade rules
- All indexes for performance
- Comments explaining each section

[Source: architecture/database-schema.md#complete-schema-script]

### Seed Data Requirements

**2 Demo Dealerships:**
1. **Acme Auto Sales**
   - Address: 123 Main St, Springfield, IL 62701
   - Phone: (555) 123-4567
   - Email: sales@acmeauto.com
   - Hours: Mon-Fri 9am-6pm, Sat 10am-4pm, Sun Closed
   - About: Family-owned dealership description

2. **Premier Motors**
   - Address: 456 Oak Ave, Springfield, IL 62702
   - Phone: (555) 987-6543
   - Email: info@premiermotors.com
   - Hours: Mon-Sat 9am-7pm, Sun 11am-5pm
   - About: Premium dealership description

**Vehicles:** 5 vehicles per dealership (10 total) with:
- Varied makes/models (Toyota, Honda, Ford, BMW, Mercedes, Audi, Lexus, etc.)
- Mix of status values (active, pending, sold, draft)
- Sample Cloudinary URLs for images (demo URLs)
- Complete descriptions

**Leads:** 3 leads for Dealership 1, 2 leads for Dealership 2
- Some with vehicle_id references, some without (general enquiries)
- Sample customer information

Complete seed script provided in architecture documentation.

[Source: architecture/database-schema.md#seed-data-script]

### Running Database Scripts with Docker

**Local Development Setup (Recommended):**

```bash
# Start PostgreSQL container
docker-compose up -d

# Run schema script
docker exec -i jeal-prototype-db psql -U postgres -d jeal_prototype < backend\db\schema.sql

# Run seed script
docker exec -i jeal-prototype-db psql -U postgres -d jeal_prototype < backend\db\seed.sql
```

**Verification Commands:**
```bash
docker exec -it jeal-prototype-db psql -U postgres -d jeal_prototype -c "SELECT COUNT(*) FROM dealership;"
# Expected: 2

docker exec -it jeal-prototype-db psql -U postgres -d jeal_prototype -c "SELECT COUNT(*) FROM vehicle;"
# Expected: 10

docker exec -it jeal-prototype-db psql -U postgres -d jeal_prototype -c "SELECT COUNT(*) FROM lead;"
# Expected: 5
```

**Production Deployment (Railway/Render):**
- For production deployment, use Railway CLI or cloud provider dashboard
- See DATABASE_SETUP.md for production deployment instructions

[Source: DATABASE_SETUP.md#option-a-docker]

### JSONB Image Arrays

Vehicle images stored as JSONB array of Cloudinary URLs:
- PostgreSQL JSONB type supports array operations
- Default value: `'[]'::jsonb` (empty array)
- JavaScript automatically parses JSONB to array on query results

**Example usage (for reference in later stories):**
```javascript
// Insert vehicle with images
const images = JSON.stringify(['https://res.cloudinary.com/...', '...']);
await db.query('INSERT INTO vehicle (..., images) VALUES (..., $1)', [images]);

// Query returns JSONB as parsed JavaScript array
const result = await db.query('SELECT images FROM vehicle WHERE id = $1', [id]);
console.log(result.rows[0].images); // ['url1', 'url2']
```

[Source: architecture/data-models.md#implementation-notes]

### Coding Standards

**JSDoc Requirements:**

All database module functions must include JSDoc comments:

**File Header Example:**
```javascript
/**
 * @fileoverview PostgreSQL database connection pool.
 * Establishes connection to Railway PostgreSQL database with SSL support for production.
 */
```

**Function Documentation:** (will be needed in later stories for query functions)
- Use `@param` for parameters with types
- Use `@returns` for return values
- Use `@throws` for error conditions
- Include `@example` for complex functions
- Comment SQL queries with their purpose

[Source: architecture/coding-standards.md#jsdoc-documentation-requirements]

### Project Structure Alignment

All file paths in this story align with the architecture specification:
- `backend/db/index.js` - Database connection pool
- `backend/db/schema.sql` - Schema script
- `backend/db/seed.sql` - Seed data script

These locations match exactly with the source tree documentation. No conflicts or deviations noted.

[Source: architecture/source-tree.md#backend-structure]

### Testing

**Testing Approach:** Manual testing only for MVP per tech-stack specifications
- No automated testing framework (Jest/Supertest deferred to Phase 2)
- Manual verification using Railway CLI commands
- Database connection test via console log output when server starts

**Verification Steps:**
1. Run schema.sql and seed.sql scripts via Railway CLI
2. Verify table counts match expected values (2 dealerships, 10 vehicles, 5 leads)
3. Query sample data to confirm schema structure
4. Start backend server and verify "Database connected successfully" console message
5. Verify no connection errors in server logs

**No specific test files required for this story.**

[Source: architecture/tech-stack.md#technology-stack-table]

### Technical Constraints

**PostgreSQL Version:** 14+ (Docker for local, Railway/Render for production)

**SSL Configuration:**
- Local Docker: SSL disabled (`ssl: false`)
- Production: SSL required with `rejectUnauthorized: false` flag

**Environment Variables:**
- Local: `DATABASE_URL=postgresql://postgres:postgres@localhost:5432/jeal_prototype`
- Production: DATABASE_URL from Railway/Render dashboard

**Connection Pooling:** Use Pool from pg client (not individual Client instances) for concurrent request handling

**SQL Injection Protection:** All queries must use parameterized queries (enforced in later stories when implementing query functions)

[Source: architecture/tech-stack.md#technology-stack-table, DATABASE_SETUP.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-20 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None - No blocking issues encountered during implementation.

### Completion Notes List

- Database setup completed using Docker PostgreSQL (local development environment per DATABASE_SETUP.md Option A)
- All three core tables created: dealership, vehicle, lead
- Foreign key constraints properly configured with ON DELETE CASCADE for dealership relationships and ON DELETE SET NULL for vehicle_id in leads
- Performance indexes created for multi-tenant query optimization
- Database seeded with 2 dealerships (Acme Auto Sales, Premier Motors), 10 vehicles (5 per dealership), and 5 leads
- Database connection module includes comprehensive JSDoc documentation per coding standards
- Connection test successful - backend can connect to PostgreSQL database via Docker
- Verified data integrity: dealership count=2, vehicle count=10, lead count=5
- Docker container configuration: jeal-prototype-db running PostgreSQL 14
- DATABASE_URL configured for local Docker: `postgresql://postgres:postgres@localhost:5432/jeal_prototype`
- SSL disabled for local development, will be enabled for production deployment

### File List

**Created:**
- `backend/db/index.js` - PostgreSQL connection pool with SSL configuration and startup test query
- `backend/db/schema.sql` - Complete database schema with tables, constraints, and indexes
- `backend/db/seed.sql` - Sample data for 2 dealerships, 10 vehicles, 5 leads

**Modified:**
- None

## QA Results

### Review Date: 2025-11-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Grade: A- (90/100)**

This is an **excellent foundational implementation** with exemplary documentation and proper database design. The schema correctly implements multi-tenancy with appropriate foreign key constraints, CASCADE rules, and performance indexes. The connection pool is properly configured with environment-aware SSL settings.

**Key Strengths:**
- ‚úÖ **Outstanding JSDoc Documentation:** backend/db/index.js includes comprehensive file headers, parameter descriptions, and inline comments that exceed coding standards requirements
- ‚úÖ **Excellent SQL Comments:** Schema and seed files include detailed explanations of multi-tenancy design, foreign key cascade behavior, and index purposes
- ‚úÖ **Proper Database Design:** Three-table schema with correct relationships, CHECK constraints for data validation, and JSONB for flexible image storage
- ‚úÖ **Realistic Seed Data:** 2 dealerships, 10 vehicles with varied status values, 5 leads - provides comprehensive test data
- ‚úÖ **Docker Integration:** docker-compose.yml includes health check, volume persistence, and matches DATABASE_SETUP.md specifications
- ‚úÖ **Security:** .env properly excluded in .gitignore (verified via git history check)

**Minor Issues Identified:**
- ‚ö†Ô∏è **Documentation Inconsistency (DOC-001):** SQL files contain outdated Railway CLI command references in comments (lines schema.sql:10-11,114 and seed.sql:9-10,235-236), but project uses Docker for local development per DATABASE_SETUP.md
- ‚ö†Ô∏è **Default Credentials (SEC-003):** .env contains weak default values (SESSION_SECRET="your-random-secret-here-change-this", ADMIN_PASSWORD="admin123") acceptable for local dev but risky if accidentally deployed to production

### Refactoring Performed

**No refactoring performed.** Code quality is excellent as-is. The identified issues are documentation updates rather than code changes, which I am recommending for the dev team to address.

### Compliance Check

- ‚úÖ **Coding Standards:** PASS - Exemplary JSDoc documentation in backend/db/index.js exceeds requirements with file overview, parameter types, and explanatory comments
- ‚úÖ **Project Structure:** PASS - Files located in correct directories per architecture/source-tree.md (backend/db/index.js, schema.sql, seed.sql)
- ‚úÖ **Testing Strategy:** PASS - Manual testing approach per tech-stack.md MVP specification; 8 manual verification steps completed successfully
- ‚úÖ **Tech Stack Compliance:** PASS - Uses pg (node-postgres) 8.11+, PostgreSQL 14-alpine, Docker as documented
- ‚úÖ **All ACs Met:** PASS - All 8 acceptance criteria fully implemented and validated (see gate file for detailed traceability)

### Improvements Checklist

- [ ] Update schema.sql comments (lines 10-11, 114) to reference Docker commands instead of Railway CLI for local development consistency
- [ ] Update seed.sql comments (lines 9-10, 235-236) to reference Docker commands instead of Railway CLI
- [ ] Add warning comment in .env file (lines 14, 16) that SESSION_SECRET and ADMIN_PASSWORD are dev-only values and MUST be changed for production
- [ ] Document backup restoration procedure for production deployment (deferred to deployment guide)
- [ ] Before implementing Stories 1.3-1.5: Create query helper function templates that enforce dealership_id filtering to mitigate SEC-001 risk

**Future Enhancements (Phase 2):**
- [ ] Consider adding CHECK constraint on vehicle.images: `CHECK (jsonb_typeof(images) = 'array')` to validate JSONB structure
- [ ] Evaluate migration tooling (Knex Migrations, Flyway) to automate schema versioning
- [ ] Consider implementing row-level security (RLS) in PostgreSQL as defense-in-depth for multi-tenancy

### Security Review

**Status: CONCERNS** (Minor issues found, not blocking for MVP)

**Findings:**
1. ‚úÖ **PASS:** .env file properly excluded in .gitignore (verified line 28)
2. ‚úÖ **PASS:** Foreign key constraints enforce multi-tenancy data integrity
3. ‚úÖ **PASS:** Architecture documentation includes SQL injection prevention guidance (parameterized queries)
4. ‚ö†Ô∏è **CONCERNS:** .env contains weak default credentials suitable for local dev but risky for production (SESSION_SECRET="your-random-secret-here-change-this", ADMIN_PASSWORD="admin123")
5. ‚ö†Ô∏è **CONCERNS:** No JSONB structure validation - vehicle.images column accepts any JSON, could store invalid data
6. üö® **CRITICAL RISK (Future Stories):** Multi-tenancy data leak risk (SEC-001, score 9) - API queries in Stories 1.3-1.5 MUST enforce dealership_id filtering

**Security Actions Taken:**
- Verified .env not committed to git repository (git status check performed)
- Documented multi-tenancy enforcement requirements for upcoming API implementation stories

**Security Recommendations:**
- Add warning comments in .env for weak default credentials
- Implement query helper functions with mandatory dealership_id parameter before Story 1.3
- Perform penetration testing for multi-tenant isolation before production deployment

### Performance Considerations

**Status: PASS**

**Findings:**
1. ‚úÖ **Connection Pooling:** Properly configured using pg Pool (index.js:21-26)
2. ‚úÖ **Critical Indexes:** All required indexes created:
   - idx_vehicle_dealership_id (multi-tenant filtering)
   - idx_lead_dealership_id (multi-tenant filtering)
   - idx_vehicle_status (public site filtering)
   - idx_lead_created_at (admin inbox sorting)
   - idx_vehicle_dealership_status (composite index for common query pattern)
3. ‚úÖ **JSONB Storage:** Efficient storage for variable-length image arrays
4. ‚ö†Ô∏è **Pool Configuration:** Uses pg defaults (no explicit max connections) - acceptable for MVP, tune for production based on Railway/Render tier limits

**Performance Recommendations:**
- Monitor query performance in production using EXPLAIN ANALYZE
- Configure pool.max based on database provider tier (Railway free tier typically supports 20 connections)
- Add slow query logging in production to identify optimization opportunities

### Files Modified During Review

**None** - No code changes were made during this review. The implementation quality is excellent as delivered by the dev agent.

### Requirements Traceability

All 8 acceptance criteria **FULLY IMPLEMENTED** with complete validation:

| AC  | Requirement | Implementation | Validation | Status |
|-----|-------------|----------------|------------|--------|
| AC1 | PostgreSQL connection with pg client | backend/db/index.js:21-26 | Startup test query logs success | ‚úÖ PASS |
| AC2 | Dealership table with all columns | backend/db/schema.sql:29-39 | 2 dealerships seeded and verified | ‚úÖ PASS |
| AC3 | Vehicle table with FK, CHECK constraints | backend/db/schema.sql:52-66 | 10 vehicles with varied status values | ‚úÖ PASS |
| AC4 | Lead table with FK to dealership/vehicle | backend/db/schema.sql:78-87 | 5 leads with mixed vehicle references | ‚úÖ PASS |
| AC5 | Foreign key constraints enforced | schema.sql:54,80-81 | CASCADE and SET NULL rules verified | ‚úÖ PASS |
| AC6 | Indexes on dealership_id columns | schema.sql:98-108 | 5 indexes created including composite | ‚úÖ PASS |
| AC7 | 2 sample dealerships seeded | seed.sql:17-35 | Acme Auto Sales, Premier Motors inserted | ‚úÖ PASS |
| AC8 | Connection test with simple query | index.js:32-38 | SELECT NOW() executed on startup | ‚úÖ PASS |

### Risk Profile Summary

**Overall Risk Score: 29/100** (High risk due to foundational security concerns, but all mitigatable)

**Critical Risks (Score 9):**
- SEC-001: Multi-tenancy data leak in future API implementation (High probability √ó High impact = 9)
  - **Mitigation:** Stories 1.3-1.5 MUST implement query helpers with enforced dealership_id filtering
  - **Timeline:** Before Story 1.3 implementation begins

**High Risks (Score 6):**
- DATA-001: Unintended data loss from cascade deletes (Medium prob √ó High impact = 6)
- SEC-002: Database credential exposure (.env file security) (Medium prob √ó High impact = 6)
- TECH-001: Connection failures from SSL/pool misconfiguration (High prob √ó Medium impact = 6)

**Medium Risks (Score 4):** 3 identified (composite indexes, JSONB validation, manual script errors)
**Low Risks (Score 2-3):** 3 identified (schema migration complexity, pool exhaustion, rollback procedures)

**See full risk profile:** docs/qa/assessments/1.2-risk-20251120.md

### Gate Status

**Gate: CONCERNS** ‚Üí docs/qa/gates/1.2-database-schema-seed-data.yml

**Reason:** Excellent implementation with all acceptance criteria met and exemplary documentation. Minor concerns include documentation inconsistencies (Railway CLI references should be Docker) and weak default credentials in .env file. Most importantly, future stories (1.3-1.5) MUST implement proper multi-tenancy filtering to address SEC-001 critical risk.

**Risk profile:** docs/qa/assessments/1.2-risk-20251120.md

### Recommended Status

‚úÖ **Ready for Done** (with conditions for future stories)

This story is **complete and ready to merge**. The database foundation is solid with proper schema design, foreign key constraints, and performance indexes. The identified concerns are minor and do not block this story's completion.

**Conditions for Story 1.2:**
- Dev team should update SQL file comments to reference Docker (low priority, cosmetic)
- Add warning comments to .env about production credentials (low priority, security best practice)

**CRITICAL Requirements for Stories 1.3-1.5:**
- API query implementations MUST use helper functions that enforce dealership_id filtering
- Code reviews MUST verify every SELECT query includes dealership_id WHERE clause
- Security testing MUST validate multi-tenant isolation before production deployment

### Testing Summary

**Manual Tests Performed (8/8 Passed):**
1. ‚úÖ Docker container startup: `docker-compose up -d` successful
2. ‚úÖ Schema script execution: Tables created (dealership, vehicle, lead)
3. ‚úÖ Seed script execution: Data inserted without errors
4. ‚úÖ Dealership count: Expected 2, Verified 2 (Acme Auto Sales, Premier Motors)
5. ‚úÖ Vehicle count: Expected 10, Verified 10 (5 per dealership, varied status)
6. ‚úÖ Lead count: Expected 5, Verified 5 (3 for dealership 1, 2 for dealership 2)
7. ‚úÖ Backend connection: Server logs "Database connected successfully at [timestamp]"
8. ‚úÖ Git security: Verified .env not committed to repository

**Test Coverage Notes:**
- Manual testing approach per MVP tech-stack specification (no automated tests required)
- All acceptance criteria validated through manual verification commands
- Database connection test automated via startup query in index.js

### Additional Notes

**Congratulations to the dev team!** This is a **textbook example** of excellent database foundation work. The JSDoc documentation, SQL comments, and schema design demonstrate strong architectural understanding and attention to detail.

The CONCERNS gate status should not be interpreted as a negative reflection on this story's quality. Rather, it serves as a **critical reminder** that multi-tenancy enforcement is deferred to API implementation stories (1.3-1.5), which must be executed with extreme care to prevent the SEC-001 data leak risk.

**Production Deployment Readiness:**
- ‚úÖ Database schema production-ready
- ‚úÖ Docker configuration suitable for local development
- ‚ö†Ô∏è Requires production credentials configuration (DATABASE_URL from Railway/Render)
- ‚ö†Ô∏è Backup restoration procedure must be documented before production deployment
- üö® API implementation stories MUST complete before production deployment (multi-tenancy enforcement)

**Next Steps:**
1. Merge this story with confidence - the foundation is solid
2. Before starting Story 1.3: Design query helper functions with mandatory dealership_id parameter
3. Add multi-tenancy compliance to code review checklist for Stories 1.3-1.5
4. Plan security testing for multi-tenant isolation after API implementation complete

---

### Review Date: 2025-11-20 (Follow-up)

### Reviewed By: Quinn (Test Architect)

### Resolution Verification

**All previous concerns have been successfully resolved!**

This follow-up review confirms that the development team addressed both issues identified in the initial review:

1. ‚úÖ **DOC-001 RESOLVED** - Documentation inconsistency fixed
   - **What was changed**: Updated SQL file comments to reference Docker commands instead of Railway CLI
   - **Files modified**:
     - backend/db/schema.sql:10-11,114 - Now correctly references `docker exec` commands for local development
     - backend/db/seed.sql:9-10,235-237 - Now correctly references `docker exec` commands
   - **Impact**: Eliminates confusion for developers following setup instructions

2. ‚úÖ **SEC-003 RESOLVED** - Security warning added for default credentials
   - **What was changed**: Added explicit warning comments about dev-only credential usage
   - **File modified**: .env:14-15
   - **New content**: "WARNING: These are DEV-ONLY default values. MUST be changed for production deployment! Generate strong values: SESSION_SECRET should be 32+ random characters, ADMIN_PASSWORD should be 12+ chars with mixed case/numbers/symbols"
   - **Impact**: Clear guidance prevents accidental deployment of weak credentials to production

### Verification Tests Performed

All acceptance criteria re-verified:

1. ‚úÖ Database connection active (Docker container status: healthy)
2. ‚úÖ Dealership count: 2 (Acme Auto Sales, Premier Motors)
3. ‚úÖ Vehicle count: 10 (5 per dealership, varied status)
4. ‚úÖ Lead count: 5 (3 for dealership 1, 2 for dealership 2)
5. ‚úÖ All indexes present and functional
6. ‚úÖ Foreign key constraints enforced
7. ‚úÖ Documentation now consistent with actual implementation
8. ‚úÖ Security warnings in place for production deployment

### Updated Gate Status

**Gate: PASS** ‚Üí docs/qa/gates/1.2-database-schema-seed-data.yml

**Reason**: All acceptance criteria fully met with excellent implementation quality. Previous concerns (documentation inconsistency and weak default credentials) have been resolved. Code demonstrates strong architectural understanding with comprehensive documentation. Foundation is production-ready pending API implementation in Stories 1.3-1.5.

### Updated Quality Score

**Quality Score: 95/100** (increased from 90/100)

Deductions:
- -5 points: Multi-tenancy enforcement deferred to future stories (architectural decision, not a defect)

### Final Recommendation

‚úÖ **APPROVED - Ready for Done**

This story represents **exemplary foundational work**. The database schema is well-designed, properly documented, and ready for API development. The team's responsiveness in addressing review feedback demonstrates strong quality culture.

**Critical Reminder for Stories 1.3-1.5:**
- API query implementations MUST use helper functions enforcing dealership_id filtering (SEC-001 mitigation)
- Every database query must be reviewed for multi-tenancy compliance
- Security testing required before production deployment

### Production Readiness Status

‚úÖ Database foundation ready for production deployment
‚úÖ Documentation complete and accurate
‚úÖ Security warnings in place
‚ö†Ô∏è Awaiting API implementation (Stories 1.3-1.5) before full production deployment
‚ö†Ô∏è Production credentials must be generated (documented in warnings)
‚ö†Ô∏è Backup/restore procedures should be tested before production launch
