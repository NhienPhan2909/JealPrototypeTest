# Story 4.2: Customizable Hero Background Images for Dealership Home Pages - Brownfield Addition

## Status

**Done**

## Story

**As a** dealership staff member,
**I want** to upload and manage a custom background image for the hero section on my dealership's home page,
**so that** I can create a more personalized and visually appealing first impression that reflects my dealership's brand identity.

## Story Context

**Existing System Integration:**

- Integrates with: Existing CMS Dealership Settings component (Story 3.6), Public Home page component (Story 1.1), and Cloudinary upload infrastructure
- Technology: React 18.2+ (frontend), Express 4.18+ (backend), PostgreSQL 14+ (database), Cloudinary (image hosting)
- Follows pattern: Existing dealership logo upload pattern in DealerSettings.jsx (Story 3.6 implementation)
- Touch points:
  - Frontend: `frontend/src/pages/admin/DealerSettings.jsx` (CMS admin interface)
  - Frontend: `frontend/src/pages/public/Home.jsx` (public-facing display)
  - Backend: `backend/routes/dealers.js` (API endpoint for dealership updates)
  - Backend: `backend/db/dealers.js` (database layer)
  - Database: `dealership` table (new column: `hero_background_image`)
  - Upload: `backend/routes/upload.js` (existing Cloudinary upload endpoint)

## Acceptance Criteria

**Functional Requirements:**

1. Database schema includes new `hero_background_image` TEXT column in dealership table (nullable, stores Cloudinary URL)
2. CMS Dealership Settings page (`/admin/settings`) displays new section titled "Home Page Hero Background Image"
3. Section includes file input for uploading images (accepts JPG, PNG, WebP formats, max 5MB file size)
4. Client-side validation enforces file type restrictions and 5MB size limit with clear error messages
5. Upon successful upload, image preview displays with 40% black overlay effect matching public display
6. Preview shows "Change Image" and "Remove Image" buttons when image exists
7. Upload uses existing `/api/upload` endpoint (not Cloudinary widget due to documented DOM mounting compatibility issues)
8. Images stored in Cloudinary folder: `dealership-hero-backgrounds`
9. Public home page (`/`) displays uploaded hero background image in hero section background
10. Hero section applies 40% black overlay (`bg-black/40`) for text readability
11. Text elements in hero section include drop-shadow (`drop-shadow-lg`) for enhanced contrast
12. Hero section falls back to blue gradient (`from-blue-600 to-blue-800`) when no image uploaded
13. PUT request to `/api/dealers/:id` includes `hero_background_image` field in request body
14. GET request to `/api/dealers/:id` returns `hero_background_image` field in response
15. Different dealerships maintain independent hero background images (multi-tenancy maintained)

**Integration Requirements:**

16. Existing DealerSettings.jsx form submission continues to work unchanged for all other fields
17. New upload functionality follows existing logo upload pattern (standard HTML file input with /api/upload endpoint)
18. Integration with existing `/api/upload` endpoint maintains current behavior for other upload use cases
19. Database migration is additive only (no existing columns modified or removed)

**Quality Requirements:**

20. Changes include appropriate JSDoc documentation updates in modified backend files
21. No regression in existing dealership settings functionality verified
22. Implementation references Story 4.2 in code comments for traceability
23. Form submission includes success message: "Dealership settings updated successfully!"
24. Responsive design maintained across mobile, tablet, and desktop viewports

## Technical Notes

- **Integration Approach:** Extends existing DealerSettings.jsx component following the established logo upload pattern. Uses standard HTML file input rather than Cloudinary widget to avoid documented DOM mounting compatibility issues encountered during implementation.

- **Existing Pattern Reference:**
  - Logo upload pattern in `frontend/src/pages/admin/DealerSettings.jsx` (Story 3.6)
  - Cloudinary upload API pattern in `backend/routes/upload.js`
  - Dealership data update pattern in `backend/routes/dealers.js` and `backend/db/dealers.js`

- **Key Constraints:**
  - Cloudinary Upload Widget NOT used due to DOM mounting errors in React 18.2+ environment
  - Standard file input approach prioritized for reliability and maintainability
  - Client-side validation must match server-side validation (file types, size limits)
  - Multi-tenancy isolation strictly maintained (SEC-001 compliance)
  - Images must use appropriate Cloudinary folder for organization: `dealership-hero-backgrounds`

- **Technical Decisions Documented:**
  - Initially attempted Cloudinary Upload Widget integration
  - Encountered persistent DOM mounting errors incompatible with current React version
  - Switched to standard HTML file input with `/api/upload` endpoint for reliability
  - This approach aligns with existing codebase patterns and provides better maintainability

## Definition of Done

- [x] Database migration executed: `backend/db/migrations/add_hero_background_image.sql`
- [x] `hero_background_image` column added to dealership table (TEXT, nullable)
- [x] DealerSettings.jsx updated with new "Home Page Hero Background Image" section
- [x] File input with client-side validation (file type, size) implemented
- [x] Image preview with overlay effect displays after upload
- [x] "Change Image" and "Remove Image" buttons functional
- [x] `/api/upload` endpoint integration working for hero background uploads
- [x] Images stored in correct Cloudinary folder: `dealership-hero-backgrounds`
- [x] PUT `/api/dealers/:id` endpoint accepts and saves `hero_background_image` field
- [x] GET `/api/dealers/:id` endpoint returns `hero_background_image` field
- [x] `backend/routes/dealers.js` updated to handle new field (lines 170, 210)
- [x] `backend/db/dealers.js` updated to persist new field (lines 50, 103)
- [x] Public Home.jsx displays uploaded background image in hero section
- [x] Hero section applies 40% black overlay for text readability
- [x] Text elements include drop-shadow for enhanced contrast
- [x] Fallback to blue gradient when no image set
- [x] Multi-tenancy verified: different dealerships have independent hero images
- [x] Existing dealership settings functionality regression tested
- [x] Code follows existing patterns and standards
- [x] JSDoc documentation updated with Story 4.2 references
- [x] Responsive design verified on mobile, tablet, desktop
- [x] Success message displays on form submission

## Minimal Risk Assessment

**Primary Risk:** Potential performance impact on home page load time due to large background images

**Mitigation:**
- Client-side 5MB file size limit reduces upload of excessively large images
- Cloudinary serves optimized images with automatic format selection and compression
- Lazy loading could be implemented in future iteration if performance issues arise
- Browser caching of Cloudinary URLs reduces repeat load times

**Rollback:**
- Database column is nullable - can be set to NULL to revert to blue gradient background
- Migration is additive only - no existing functionality removed
- Simple UPDATE query can clear `hero_background_image` values: `UPDATE dealership SET hero_background_image = NULL WHERE id = ?`

**Additional Risks:**
- **Risk:** Inappropriate or low-quality images uploaded by dealership staff
- **Mitigation:** File type and size validation; potential future enhancement could add image dimension recommendations or content moderation

- **Risk:** Cloudinary URL changes or service interruption
- **Mitigation:** Graceful fallback to blue gradient ensures home page remains functional even if image fails to load

## Dev Notes

### Architectural Context

This story implements a brownfield enhancement to the existing dealership CMS and public home page. The implementation integrates with established patterns for file uploads, dealership data management, and public page rendering.

**Brownfield Integration Points:**
1. **CMS Admin (Story 3.6):** Extends existing DealerSettings component with new upload section
2. **Public Home (Story 1.1):** Modifies hero section styling to support background images
3. **Upload Infrastructure:** Utilizes existing `/api/upload` endpoint and Cloudinary integration
4. **Database Layer:** Additive schema change maintains backward compatibility

**Data Flow:**
1. Admin uploads image via DealerSettings.jsx file input
2. Frontend sends image to `/api/upload` endpoint
3. Backend uploads to Cloudinary (folder: `dealership-hero-backgrounds`)
4. Cloudinary returns secure URL
5. Frontend sends PUT request to `/api/dealers/:id` with Cloudinary URL
6. Backend stores URL in `dealership.hero_background_image` column
7. Public home page fetches dealership data including `hero_background_image`
8. Home.jsx renders background image with overlay or falls back to gradient

### Previous Story Context

**Story 3.6 (Dealership Settings Management):**
- Established DealerSettings.jsx component structure
- Implemented logo upload pattern using Cloudinary Upload Widget
- Story 4.2 extends this component with hero background upload capability
- **Key Difference:** Story 4.2 uses standard file input instead of Cloudinary widget due to documented DOM compatibility issues

**Story 1.1 (Public Home Page):**
- Created initial Home.jsx component with static blue gradient hero section
- Story 4.2 enhances hero section with dynamic background image support
- Maintains text overlay and calls-to-action from original implementation

**Story 1.2 (Database Schema):**
- Defined initial dealership table schema
- Story 4.2 adds `hero_background_image` column via additive migration

### Technology Stack

**Frontend:**
- React 18.2+ with functional components and hooks (useState, useEffect)
- Tailwind CSS for styling (utility classes: bg-black/40, drop-shadow-lg, from-blue-600, to-blue-800)
- Standard HTML file input (not React Hook Form for upload section)
- Fetch API for image upload and dealership data updates

**Backend:**
- Express 4.18+ for routing
- Existing `/api/upload` endpoint with Cloudinary SDK integration
- Multer middleware for multipart/form-data handling
- PostgreSQL parameter validation and sanitization

**Database:**
- PostgreSQL 14+ with additive migration
- New column: `hero_background_image TEXT NULL`
- Migration file: `backend/db/migrations/add_hero_background_image.sql`

**External Services:**
- Cloudinary for image hosting and optimization
- Folder organization: `dealership-hero-backgrounds`
- Automatic format optimization (WebP for supported browsers)

### Source Tree References

**Database Migration:**
- `backend/db/migrations/add_hero_background_image.sql` - Adds hero_background_image column

**Files Modified:**
- `frontend/src/pages/admin/DealerSettings.jsx` - Added "Home Page Hero Background Image" section (~80 lines)
- `frontend/src/pages/public/Home.jsx` - Modified hero section background (lines 48-79, ~32 lines)
- `backend/routes/dealers.js` - Added hero_background_image field handling (lines 170, 210, ~2 lines)
- `backend/db/dealers.js` - Added hero_background_image to update query (lines 50, 103, ~2 lines)

**Files Referenced (No Changes):**
- `backend/routes/upload.js` - Existing Cloudinary upload endpoint used as-is

### API Contract

**Existing Endpoint Enhanced:**
```
PUT /api/dealers/:id
```

**Request Body (New Field Added):**
```json
{
  "name": "string",
  "logo_url": "string (nullable)",
  "address": "string",
  "phone": "string",
  "email": "string",
  "hours": "string (nullable)",
  "finance_policy": "string (nullable)",
  "warranty_policy": "string (nullable)",
  "about": "string (nullable)",
  "hero_background_image": "string (nullable)"  // NEW FIELD
}
```

**Response (Updated):**
```json
{
  "id": 1,
  "name": "string",
  "logo_url": "string",
  "address": "string",
  "phone": "string",
  "email": "string",
  "hours": "string",
  "finance_policy": "string",
  "warranty_policy": "string",
  "about": "string",
  "hero_background_image": "string",  // NEW FIELD
  "created_at": "timestamp",
  "updated_at": "timestamp"
}
```

**Existing Upload Endpoint (Used As-Is):**
```
POST /api/upload
Content-Type: multipart/form-data
```

**Request:**
- Form field: `image` (file)
- Query param (optional): `folder=dealership-hero-backgrounds`

**Response:**
```json
{
  "url": "https://res.cloudinary.com/[cloud-name]/image/upload/v[timestamp]/dealership-hero-backgrounds/[public-id].[format]"
}
```

### Security Considerations

**File Upload Security:**
- Client-side validation: file type (JPG, PNG, WebP) and size (max 5MB)
- Server-side validation already implemented in `/api/upload` endpoint
- Cloudinary handles malware scanning and content validation
- No direct file system access - all uploads proxied through Cloudinary

**Input Validation:**
- `hero_background_image` field validated as URL format on backend
- Null values explicitly allowed (optional feature)
- XSS prevention: URLs stored as plain text, rendered in CSS background-image property (safe context)

**Multi-Tenancy (SEC-001):**
- CRITICAL: `dealershipId` always included in WHERE clause for GET/PUT operations
- Each dealership can only access/modify their own hero background image
- No cross-dealership data leakage possible

**SQL Injection Prevention:**
- Parameterized queries used in `backend/db/dealers.js` for all database operations
- No string concatenation of user input in SQL statements

### Performance Optimization

**Image Delivery:**
- Cloudinary CDN provides global edge caching for fast load times
- Automatic format optimization (WebP for modern browsers, JPEG/PNG fallback)
- Automatic quality and compression optimization
- Browser caching headers set by Cloudinary

**Frontend Optimization:**
- CSS `background-image` property loads image asynchronously (non-blocking)
- Fallback gradient renders immediately while image loads
- No layout shift during image load (hero section has fixed height)

**Database Impact:**
- Single TEXT column addition (minimal storage overhead)
- Nullable column (no impact on existing rows)
- No additional indexes required (not a search/filter column)

### UX Considerations

**Upload Flow:**
1. Admin clicks "Choose File" button
2. System validates file type and size immediately
3. If invalid: error message displays ("File must be JPG, PNG, or WebP under 5MB")
4. If valid: upload begins with loading indicator
5. On success: preview displays with overlay effect
6. Admin clicks "Save Settings" to persist change
7. Success message confirms save
8. Navigate to public home page to see change

**Visual Feedback:**
- Image preview with overlay shows exactly how hero section will appear
- "Change Image" button replaces existing image
- "Remove Image" button reverts to blue gradient
- Loading states during upload and save operations
- Error messages for validation failures or upload errors

**Accessibility:**
- Text overlay contrast maintained with 40% black overlay and drop-shadow
- Fallback gradient ensures text always readable even if image fails
- Alt text not required (decorative background image)
- Keyboard navigation supported for file input and buttons

### Testing

**Manual Testing Checklist:**
1. Database migration executed successfully
2. Admin settings page displays new upload section
3. File type validation rejects invalid formats (PDF, GIF, etc.)
4. File size validation rejects files over 5MB
5. Valid image uploads successfully to Cloudinary
6. Image stored in correct folder: dealership-hero-backgrounds
7. Preview displays uploaded image with overlay effect
8. "Change Image" button allows replacing existing image
9. "Remove Image" button clears hero background (reverts to gradient)
10. Form submission saves hero_background_image to database
11. Public home page displays uploaded background image
12. Hero overlay (40% black) and text drop-shadow render correctly
13. Fallback to blue gradient when no image set
14. Multi-tenancy: Dealership A and B have independent hero images
15. Existing settings fields (name, address, logo, etc.) still save correctly
16. No console errors during upload, save, or page navigation
17. Responsive design works on mobile (320px), tablet (768px), desktop (1920px)

**Regression Testing:**
- Verify existing logo upload still works
- Verify other dealership fields (hours, finance_policy, warranty_policy, about) still save
- Verify public home page hero section still displays properly without image
- Verify dealership selector functionality unchanged
- Verify admin authentication and authorization unchanged

**Security Testing:**
- Test SQL injection: attempt to inject SQL in hero_background_image URL field
- Test XSS: attempt to inject JavaScript in URL field
- Test multi-tenancy: verify dealership A cannot access dealership B's settings
- Test file upload: attempt to upload PHP, EXE, or other executable file types

**Performance Testing:**
- Measure home page load time with and without hero background image
- Verify Cloudinary CDN caching (check network tab for cache headers)
- Test with slow 3G network to ensure graceful degradation

### Database Migration

**Migration File:** `backend/db/migrations/add_hero_background_image.sql`

```sql
-- Story 4.2: Add hero_background_image column to dealership table
-- Allows each dealership to customize their home page hero section background

ALTER TABLE dealership
ADD COLUMN hero_background_image TEXT NULL;

COMMENT ON COLUMN dealership.hero_background_image IS 'Cloudinary URL for custom hero section background image on public home page (Story 4.2)';
```

**Rollback Migration (if needed):**
```sql
-- Rollback Story 4.2: Remove hero_background_image column

ALTER TABLE dealership
DROP COLUMN IF EXISTS hero_background_image;
```

**Migration Execution:**
```bash
# Execute migration
psql -U [username] -d [database_name] -f backend/db/migrations/add_hero_background_image.sql

# Verify column added
psql -U [username] -d [database_name] -c "SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_name = 'dealership' AND column_name = 'hero_background_image';"
```

## Implementation Summary

### Database Changes
- **File:** `backend/db/migrations/add_hero_background_image.sql`
- **Change:** Added `hero_background_image TEXT NULL` column to dealership table
- **Impact:** Additive only, no existing data affected

### Backend API Changes
- **File:** `backend/routes/dealers.js`
  - **Line 170:** Added `hero_background_image` to request body extraction
  - **Line 210:** Added `hero_background_image` to database update call
  - **Impact:** PUT and GET endpoints now handle new field

- **File:** `backend/db/dealers.js`
  - **Line 50:** Added `hero_background_image` to field list in getById query
  - **Line 103:** Added `hero_background_image` to dynamic UPDATE query
  - **Impact:** Database layer persists and retrieves new field

- **File:** `backend/routes/upload.js`
  - **No changes required:** Existing endpoint used as-is for hero background uploads

### Frontend Changes
- **File:** `frontend/src/pages/admin/DealerSettings.jsx`
  - **Added:** "Home Page Hero Background Image" section (~80 lines)
  - **Features:** File input, client-side validation, preview with overlay, change/remove buttons
  - **Integration:** Uses `/api/upload` endpoint for Cloudinary uploads

- **File:** `frontend/src/pages/public/Home.jsx`
  - **Lines 48-79:** Modified hero section background styling
  - **Changes:**
    - Replaced static blue gradient with dynamic background image
    - Added 40% black overlay (`bg-black/40`) for text readability
    - Added drop-shadow to text elements (`drop-shadow-lg`)
    - Falls back to blue gradient when no image set
  - **Impact:** Hero section now supports customizable backgrounds per dealership

### Technical Decisions Documented
1. **Cloudinary Widget NOT Used:** Initial implementation attempted Cloudinary Upload Widget but encountered persistent DOM mounting errors incompatible with React 18.2+. Standard HTML file input with `/api/upload` endpoint chosen for reliability and maintainability.

2. **File Size Limit:** 5MB maximum enforced client-side and server-side to balance image quality with performance.

3. **Image Folder Organization:** All hero backgrounds stored in `dealership-hero-backgrounds` Cloudinary folder for easy management and organization.

4. **Overlay Approach:** 40% black overlay chosen after testing to ensure text readability across wide variety of background images while maintaining visual appeal.

5. **Fallback Strategy:** Blue gradient fallback ensures hero section always displays properly, even when no image uploaded or if Cloudinary URL fails to load.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-28 | 1.0 | Initial brownfield story creation documenting implemented feature | PM (John) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (model ID: claude-sonnet-4-5-20250929)

### Completion Notes List

**Feature Successfully Implemented - Documenting Completed Work**

This brownfield user story documents a feature that was implemented and completed prior to story creation. All acceptance criteria have been met and the feature is currently deployed in the application.

**Implementation Highlights:**
1. Database migration cleanly executed with additive-only schema change
2. Backend API seamlessly integrated new field into existing dealer endpoints
3. CMS admin interface follows established logo upload pattern for consistency
4. Public home page gracefully handles both image and gradient backgrounds
5. Multi-tenancy and security requirements strictly maintained
6. No regression in existing functionality
7. Responsive design maintained across all viewports
8. Technical decisions documented for future reference

**Key Success Factors:**
- Followed existing codebase patterns for maintainability
- Prioritized reliability over feature complexity (file input vs. widget)
- Implemented graceful fallbacks for robustness
- Maintained backward compatibility throughout
- Documented technical decisions and constraints for future developers

### File List

**Database Migration:**
- `backend/db/migrations/add_hero_background_image.sql` - Adds hero_background_image column to dealership table

**Files Modified:**
- `frontend/src/pages/admin/DealerSettings.jsx` - Added hero background upload section
- `frontend/src/pages/public/Home.jsx` - Enhanced hero section with dynamic background support
- `backend/routes/dealers.js` - Updated PUT/GET endpoints to handle hero_background_image field
- `backend/db/dealers.js` - Updated database queries to persist and retrieve hero_background_image

**Files Referenced (No Changes):**
- `backend/routes/upload.js` - Existing Cloudinary upload endpoint utilized
